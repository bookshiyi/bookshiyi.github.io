---
title: 乞丐版服务器解决内存崩溃的心路历程
tags:
  - apache
  - 建站
  - 服务器
url: 2611.html
id: 2611
categories:
  - 建站
date: 2018-05-01 16:46:57
---

### 起因和经过（不用看）：

        说来话长，且听我娓娓道来，大概是15年左右，被阿里“学生认证”服务器10元/月诱惑后入坑，开始做个人博客，开始很少有搜索收录和流量，所以也没什么问题，但是禁不住折腾啊，17年经常出现“ _Error establishing_ a _database connection_.”，关键问题是这种错误通过正常的http监控是查不出来的（起码当时的我还不会监测站点http内容），不过这当然这算不上什么大问题，毕竟美国幽默大师马克·吐温说：“没有什么事是重启一次系统解决不了的，如果有那就重启两次”，如果你不记得马克·吐温说过这句话，那肯定是没听过马克吐温还说过：“如果一句话不知道谁说的，就说是马克·吐温说的”。

        就这么维持了大半年的时间，没事就看看网站，只要宕机就重启一下，开始还好，基本两周重启一次，周末可能要重启一次，也没什么大不了的，正好可以经常去看看自己站点不然还容易把它忘了，不知不觉竟然发现了一个估算网站流量的方法，可是后来，流量越来越多而且访问深度也越来越深，发现靠重启过日子真是不靠谱，一天可能要重启好几次，痛下决心重装系统，本着“没有什么事是装一次系统解决不了的，如果有那就装两次”，使用了在阿里云开放镜像市场的的一键安装环境，功能比较全，部署好之后可以让站长专心于创作而不是被重启机器维护服务器分散精力，很快就部署好，开始专心迁移数据重新架构网站，折腾了一段时间。

        开机后内存正常，比以前还低，cpu正常，用多个浏览器同时访问网站，内存稍稍上升，完全无压力，嗯，默默断开ssh的我，终于可以不用再担心服务器宕机了。

        如果真有“装一次系统就解决就所有问题”就好了，好景不长，几个小时后网站很快再次出现“Error establ.......”，看下内存监控，是从开机后稳定上升的，直到90%多，再过一会直接降到就30%了，此时网站就无法访问了。

        我开始怀疑MySQL，是不是运行越久缓存越多，去查MySQL运行日志，也想了一些解决办法（优化数据库结构，升级数据库版本之类，甚至还做了一个检测MySQL服务状态检测的脚本，一旦数据库进程死掉立即重新创建一个），效果却不明显，“要不再入一个数据库”？也太丢人了，就这么点流量都处理不好就想花钱解决了？没门。那就询问下客服吧，客服给出建议是推荐新购通地区服务器实例自建内网数据库，就这么点流量就想让我花钱了？没门。

        一定是服务器配置有问题，我坚信，可是不是MySQL的问题？还能是谁？ 再次默默打开ssh，重新查进程，网站运行一段时间后发现httpd进程很可疑，占了内存的一大半，竟然是你，Apache！

Apache的机制是：有访客访问站点就会创建进程，访客悄悄地走了也不会带走一片云彩一个进程，默认参数下这些空闲进程不会主动释放，访问流量越多Apache进程也越来多，直到把他好朋友MySQL挤出了内存，结果我还对MySQL怀恨在心，简直罪过。。。

### 解决方法：

         既然找到问题就好，开始解决，经查，工作在perfork模式下的Apache中有一个参数MaxRequestsPerChild ，用来控制每个进程在处理了多少次请求之后自动销毁，这个参数可以设置为0表示无限（即不销毁进程）。修改这个参数即可，这里有一段小插曲，在某些系统里这个参数不一定在apache/conf/httpd.conf里面，可能在apache/conf/extra/http-mpm.conf里面，修改一个比较合理的参数，可以通过命令“ ps aux|grep -v grep|awk '/httpd/{sum+=$6;n++};END{print sum/n}' ”得到apache进程占用的平均内存，然后结合总内存确定这个参数的大小。

         还有一些相关的参数，此处摘抄过来仅供参考，具体配置方法不再赘述：

> **ServerLimit 2000**#有这个参数就不必像apache1一样修改源码才能修改256客户数的限制,听讲要放到最前面才会生效,2000是这个参数的最大值 **StartServers 10**#指定服务器启动时建立的子进程数量,prefork默认为5. **MinSpareServers 25**#指定空闲子进程的最小数量,默认为5.如果当前空闲子进程数少于MinSpareServers ,那么Apache将以最大每秒一个的速度产生新的子进程.此参数不要设的太大. **MaxSpareServers 50**#设置空闲子进程的最大数量,默认为10.如果当前有超过MaxSpareServers数量的空闲子进程,那么父进程将杀死多余的子进程.此参数 不要设的太大.如果你将该指令的值设置为比MinSpareServers小,Apache将会自动将其修改成"MinSpareServers+1". **MaxClients 2000**#限定同一时间客户端最大接入请求的数量(单个进程并发线程数),默认为256.任何超过MaxClients限制的请求都将进入等候队列,一旦一个链接被释放,队列中的请求将得到服务.要增大这个值,你必须同时增大ServerLimit . **MaxRequestsPerChild 10000**#每个子进程在其生存期内允许伺服的最大请求数量,默认为10000.到达MaxRequestsPerChild的限制后,子进程将会结束.

 

        当然了，朋友们，玩命访问吧，不用爱惜我的服务器，只有你们的努力才能让服务器宕机，我才有升级机器配置的理由！